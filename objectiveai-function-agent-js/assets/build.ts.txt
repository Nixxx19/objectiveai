import { Functions } from "objectiveai";
import { writeFileSync } from "node:fs";

// Import function fields from function/*.json
import functionType from "./function/type.json";
import functionDescription from "./function/description.json";
import functionInputMaps from "./function/input_maps.json";
import functionInputSchema from "./function/input_schema.json";
import functionTasks from "./function/tasks.json";
import functionOutput from "./function/output.json";
import functionOutputLength from "./function/output_length.json";
import functionInputSplit from "./function/input_split.json";
import functionInputMerge from "./function/input_merge.json";

// Import name for profile description
import name from "./github/name.json";

// Profile for vector completion tasks
const vectorCompletionTaskProfile: Functions.VectorCompletionTaskProfile = {
  ensemble: {
    llms: [
      {
        count: 1,
        model: "openai/gpt-4.1-nano",
        output_mode: "json_schema",
      },
      {
        count: 1,
        model: "google/gemini-2.5-flash-lite",
        output_mode: "json_schema",
      },
      {
        count: 1,
        model: "deepseek/deepseek-v3.2",
        output_mode: "instruction",
        top_logprobs: 20,
      },
      {
        count: 1,
        model: "openai/gpt-4o-mini",
        output_mode: "json_schema",
        top_logprobs: 20,
      },
      {
        count: 1,
        model: "x-ai/grok-4.1-fast",
        output_mode: "json_schema",
        reasoning: {
          enabled: false,
        },
      },
    ],
  },
  profile: [1, 1, 1, 1, 1],
};

function buildFunction(): void {
  // Construct function from JSON imports
  const func: Record<string, unknown> = {};

  if (functionType !== null) func.type = functionType;
  if (functionDescription !== null) func.description = functionDescription;
  if (functionInputMaps !== null) func.input_maps = functionInputMaps;
  if (functionInputSchema !== null) func.input_schema = functionInputSchema;
  if (functionTasks !== null) func.tasks = functionTasks;
  if (functionOutput !== null) func.output = functionOutput;
  if (functionOutputLength !== null) func.output_length = functionOutputLength;
  if (functionInputSplit !== null) func.input_split = functionInputSplit;
  if (functionInputMerge !== null) func.input_merge = functionInputMerge;

  // serialize Function into function.json
  writeFileSync("function.json", JSON.stringify(func, null, 2));
}

function buildProfile(): void {
  // Construct profile tasks based on function tasks
  const profileTasks: Functions.TaskProfile[] = [];

  if (functionTasks) {
    for (const task of functionTasks as Functions.Task[]) {
      if (task.type === "vector.completion") {
        // Use the vector completion task profile constant
        profileTasks.push(vectorCompletionTaskProfile);
      } else if (
        task.type === "scalar.function" ||
        task.type === "vector.function"
      ) {
        // Use identical owner, repository, and commit as the function task
        const funcTask = task as
          | Functions.ScalarFunctionTask
          | Functions.VectorFunctionTask;
        profileTasks.push({
          owner: funcTask.owner,
          repository: funcTask.repository,
          commit: funcTask.commit,
        });
      }
    }
  }

  // Construct the profile with description
  const profile: Functions.RemoteProfile = {
    description: `Default profile for ${name ?? ""}`,
    tasks: profileTasks,
  };

  // serialize Profile into profile.json
  writeFileSync("profile.json", JSON.stringify(profile, null, 2));
}

buildFunction();
buildProfile();
